!function(e){e.fn.justifiedGallery=function(t){function i(e,t,i){var n;return n=e>t?e:t,n<=100?i.settings.sizeRangeSuffixes.lt100:n<=240?i.settings.sizeRangeSuffixes.lt240:n<=320?i.settings.sizeRangeSuffixes.lt320:n<=500?i.settings.sizeRangeSuffixes.lt500:n<=640?i.settings.sizeRangeSuffixes.lt640:i.settings.sizeRangeSuffixes.lt1024}function n(t){e(t.currentTarget).find(".caption").slideDown("fast")}function s(t){e(t.currentTarget).find(".caption").slideUp("fast")}function a(t,a,g,r,o,l,f){var d=t.find("img");d.css("width",r),d.css("height",o),d.css("margin-left",-r/2),d.css("margin-top",-o/2),t.width(r),t.height(l),t.css("top",g),t.css("left",a);var u=d.attr("src"),h=u.replace(f.settings.extension,"").replace(f.usedSizeRangeRegExp,"")+i(r,o,f)+u.match(f.settings.extension)[0];d.one("error",function(){d.attr("src",d.data("jg.originalSrc"))}),t.stop().fadeTo(300,1,function(){u!==h&&d.attr("src",h)});var w=t.data("jg.captionMouseEvents");if(!0===f.settings.captions){var c=t.find(".caption");if(0===c.length){var m=d.attr("alt");void 0===m&&(m=t.attr("title")),void 0!==m&&(c=e('<div class="caption">'+m+"</div>"),t.append(c),c.hide())}0!==c.length&&void 0===w&&(w={mouseenter:n,mouseleave:s},t.on("mouseenter",w.mouseenter),t.on("mouseleave",w.mouseleave),t.data("jg.captionMouseEvents",w))}else void 0!==w&&(t.off("mouseenter",w.mouseenter),t.off("mouseleave",w.mouseleave),t.removeData("jg.captionMouseEvents"))}function g(e,t){var i,n,s,a,g,r,o=!0,l=0,f=e.galleryWidth,d=f-e.buildingRow.width-(e.buildingRow.entriesBuff.length-1)*e.settings.margins;if(t&&"hide"===e.settings.lastRow&&d/f>.35){for(i=0;i<e.buildingRow.entriesBuff.length;i++)n=e.buildingRow.entriesBuff[i],n.stop().fadeTo(0);return-1}for(t&&"nojustify"===e.settings.lastRow&&d/f>.35&&(o=!1),i=0;i<e.buildingRow.entriesBuff.length;i++)s=e.buildingRow.entriesBuff[i].find("img"),a=Math.ceil(s.data("jg.imgw")/(s.data("jg.imgh")/e.settings.rowHeight)),o?(g=i<e.buildingRow.entriesBuff.length-1?a+Math.ceil(a/e.buildingRow.width*d):f,r=Math.ceil(e.settings.rowHeight*(g/a)),e.settings.fixedHeight&&r<e.settings.rowHeight&&(g=a,r=e.settings.rowHeight)):(g=a,r=e.settings.rowHeight),s.data("jg.imgw",g),s.data("jg.imgh",r),f-=g+(i<e.buildingRow.entriesBuff.length-1?e.settings.margins:0),(0===i||l>r)&&(l=r);return e.settings.fixedHeight&&(l=e.settings.rowHeight),l}function r(e){e.lastAnalyzedIndex=-1,e.buildingRow.entriesBuff=[],e.buildingRow.width=0,e.offY=0,e.firstRowFlushed=!1}function o(e,t){var i,n,s,r=0;if(s=g(e,t),t&&"hide"===e.settings.lastRow&&-1===s)return e.buildingRow.entriesBuff=[],void(e.buildingRow.width=0);e.settings.maxRowHeight>0&&e.settings.maxRowHeight<s?s=e.settings.maxRowHeight:0===e.settings.maxRowHeight&&1.5*e.settings.rowHeight<s&&(s=1.5*e.settings.rowHeight);for(var o=0;o<e.buildingRow.entriesBuff.length;o++)i=e.buildingRow.entriesBuff[o],n=i.find("img"),a(i,r,e.offY,n.data("jg.imgw"),n.data("jg.imgh"),s,e),r+=n.data("jg.imgw")+e.settings.margins;e.$gallery.height(e.offY+s+(e.spinner.active?e.spinner.$el.innerHeight():0)),t||(e.offY+=s+e.settings.margins,e.buildingRow.entriesBuff=[],e.buildingRow.width=0,e.firstRowFlushed=!0,e.$gallery.trigger("jg.rowflush"))}function l(e){e.checkWidthIntervalId=setInterval(function(){var t=parseInt(e.$gallery.width(),10);e.galleryWidth!==t&&(e.galleryWidth=t,r(e),h(e,!0))},e.settings.refreshTime)}function f(e){clearInterval(e.intervalId),e.intervalId=setInterval(function(){e.phase<e.$points.length?e.$points.eq(e.phase).fadeTo(e.timeslot,1):e.$points.eq(e.phase-e.$points.length).fadeTo(e.timeslot,0),e.phase=(e.phase+1)%(2*e.$points.length)},e.timeslot)}function d(e){clearInterval(e.intervalId),e.intervalId=null}function u(e){e.yield.flushed=0,null!==e.imgAnalyzerTimeout&&clearTimeout(e.imgAnalyzerTimeout)}function h(e,t){u(e),e.imgAnalyzerTimeout=setTimeout(function(){w(e,t)},.001),w(e,t)}function w(t,i){for(var n=t.firstRowFlushed,s=t.lastAnalyzedIndex+1;s<t.entries.length;s++){var a=e(t.entries[s]),g=a.find("img");if(!0===g.data("jg.loaded")){var r=Math.ceil(g.data("jg.imgw")/(g.data("jg.imgh")/t.settings.rowHeight));if(n=t.firstRowFlushed&&s>=t.entries.length-1,t.buildingRow.width+(t.settings.fixedHeight?r:r/2)+(t.buildingRow.entriesBuff.length-1)*t.settings.margins>t.galleryWidth&&(o(t,n),++t.yield.flushed>=t.yield.every))return void h(t,i);t.buildingRow.entriesBuff.push(a),t.buildingRow.width+=r,t.lastAnalyzedIndex=s}else if("error"!==g.data("jg.loaded"))return}t.buildingRow.entriesBuff.length>0&&o(t,n),t.spinner.active&&(t.spinner.active=!1,t.$gallery.height(t.$gallery.height()-t.spinner.$el.innerHeight()),t.spinner.$el.detach(),d(t.spinner)),u(t),i?t.$gallery.trigger("jg.resize"):t.$gallery.trigger("jg.complete")}function c(e){function t(t){if("string"!=typeof e.settings.sizeRangeSuffixes[t])throw"sizeRangeSuffixes."+t+" must be a string"}function i(t){if("string"==typeof e.settings[t]){if(e.settings[t]=parseInt(e.settings[t],10),isNaN(e.settings[t]))throw"invalid number for "+t}else{if("number"!=typeof e.settings[t])throw t+" must be a number";if(isNaN(e.settings[t]))throw"invalid number for "+t}}if("object"!=typeof e.settings.sizeRangeSuffixes)throw"sizeRangeSuffixes must be defined and must be an object";if(t("lt100"),t("lt240"),t("lt320"),t("lt500"),t("lt640"),t("lt1024"),i("rowHeight"),i("maxRowHeight"),i("margins"),"nojustify"!==e.settings.lastRow&&"justify"!==e.settings.lastRow&&"hide"!==e.settings.lastRow)throw'lastRow must be "nojustify", "justify" or "hide"';if("boolean"!=typeof e.settings.fixedHeight)throw"fixedHeight must be a boolean";if("boolean"!=typeof e.settings.captions)throw"captions must be a boolean";if(i("refreshTime"),"boolean"!=typeof e.settings.randomize)throw"randomize must be a boolean"}var m={sizeRangeSuffixes:{lt100:"",lt240:"",lt320:"",lt500:"",lt640:"",lt1024:""},rowHeight:120,maxRowHeight:0,margins:1,lastRow:"nojustify",fixedHeight:!1,captions:!0,rel:null,target:null,extension:/\.[^.]+$/,refreshTime:250,randomize:!1};return this.each(function(i,n){var s=e(n);s.addClass("justified-gallery");var a=s.data("jg.context");if(void 0===a){if(void 0!==t&&null!==t&&"object"!=typeof t)throw"The argument must be an object";var g=e('<div class="spinner"><span></span><span></span><span></span></div>');a={settings:e.extend({},m,t),imgAnalyzerTimeout:null,entries:null,buildingRow:{entriesBuff:[],width:0},lastAnalyzedIndex:-1,firstRowFlushed:!1,yield:{every:2,flushed:0},offY:0,spinner:{active:!1,phase:0,timeslot:150,$el:g,$points:g.find("span"),intervalId:null},checkWidthIntervalId:null,galleryWidth:s.width(),$gallery:s},s.data("jg.context",a)}else"norewind"===t||(a.settings=e.extend({},a.settings,t),r(a));if(c(a),a.entries=s.find("a").toArray(),0!==a.entries.length){a.settings.randomize&&(a.entries.sort(function(){return 2*Math.random()-1}),e.each(a.entries,function(){e(this).appendTo(s)})),a.usedSizeRangeRegExp=new RegExp("("+a.settings.sizeRangeSuffixes.lt100+"|"+a.settings.sizeRangeSuffixes.lt240+"|"+a.settings.sizeRangeSuffixes.lt320+"|"+a.settings.sizeRangeSuffixes.lt500+"|"+a.settings.sizeRangeSuffixes.lt640+"|"+a.settings.sizeRangeSuffixes.lt1024+")$"),a.settings.maxRowHeight>0&&a.settings.maxRowHeight<a.settings.rowHeight&&(a.settings.maxRowHeight=a.settings.rowHeight);var o=!1;e.each(a.entries,function(t,i){var n=e(i),g=n.find("img");if(!0!==g.data("jg.loaded")){g.data("jg.loaded",!1),o=!0,!1===a.spinner.active&&(a.spinner.active=!0,s.append(a.spinner.$el),s.height(a.offY+a.spinner.$el.innerHeight()),f(a.spinner)),null!==a.settings.rel&&n.attr("rel",a.settings.rel),null!==a.settings.target&&n.attr("target",a.settings.target);var r=void 0!==g.data("safe-src")?g.data("safe-src"):g.attr("src");g.data("jg.originalSrc",r),g.attr("src",r);var l=new Image,d=e(l);d.one("load",function(){g.off("load error"),g.data("jg.imgw",l.width),g.data("jg.imgh",l.height),g.data("jg.loaded",!0),h(a,!1)}),d.one("error",function(){g.off("load error"),g.data("jg.loaded","error"),h(a,!1)}),l.src=r}}),o||h(a,!1),l(a)}})}}(jQuery);